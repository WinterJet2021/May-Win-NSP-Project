<!-- Demo/ui/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nurse Scheduling System</title>

  <!-- UI / libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

  <style>
    .shift-M { background-color: #e3f2fd; }  /* Morning */
    .shift-A { background-color: #fff8e1; }  /* Afternoon/Evening */
    .shift-N { background-color: #e8f5e9; }  /* Night */
    .shift-OFF { background-color: #f5f5f5; }
    .unmet { background-color: #ffebee; }
    code.small { font-size: 12px; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useRef } = React;

    // --------- constants ----------
    const CHATBOT_PROXY = '/api/chatbot';            // Same-origin proxy exposed by Demo/ui Flask server
    const UI_BASE       = '';                        // Same-origin Demo/ui backend
    const TARGET_MIN_NURSES = 16;                    // enforce at least 16 in UI import

    // ---------- shared initial structures ----------
    const initialData = {
      nurses: [],
      shifts: ['M', 'A', 'N'],
      dates: [],
      coverage: [],
      assignments: [],
      shortfall: [],
      diagnostics: {}
    };

    const defaultWeights = {
      pref_shift_weight: 1.0,
      pref_dayoff_weight: 1.0,
      shortfall_penalty: 1000,
      overage_penalty: 1000,
      no_consecutive_nights: true,
      WSMin: 0,
      WSMax: 9999,
      head_nurse_id: ""
    };

    // ---------- helpers ----------
    const fmtDay = (iso) => new Date(iso).toLocaleDateString('en-US',{month:'short',day:'numeric',weekday:'short'});
    const pad = (n) => n < 10 ? `0${n}` : `${n}`;
    const rangeDates = (startISO, endISO) => {
      const out = [];
      let d = new Date(startISO);
      const end = new Date(endISO);
      while (d <= end) {
        const iso = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        out.push(iso);
        d.setDate(d.getDate()+1);
      }
      return out;
    };

    function nextIndexFromExisting(nurses) {
      let maxIdx = 0;
      for (const n of nurses) {
        const id = n?.id || "";
        if (typeof id === "string" && /^N\d{3}$/.test(id)) {
          const num = parseInt(id.slice(1), 10);
          if (!Number.isNaN(num)) maxIdx = Math.max(maxIdx, num);
        }
      }
      return maxIdx + 1;
    }

    function ensureMinNurses(nurses, minCount = TARGET_MIN_NURSES) {
      let list = Array.isArray(nurses) ? [...nurses] : [];
      if (list.length >= minCount) return list;
      const add = minCount - list.length;
      const startIdx = nextIndexFromExisting(list);
      return [...list, ...buildToyNurses(startIdx, add)];
    }

    function buildToyNurses(startIdx = 1, count = 1) {
      const out = [];
      const dayNames = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
      for (let i = 0; i < count; i++) {
        const idx = startIdx + i;
        const id = `N${String(idx).padStart(3,'0')}`;
        out.push({
          id,
          name: `Nurse ${idx}`,
          level: 1 + (idx % 3),
          employment_type: "full_time",
          unit: "ER",
          preferences: {
            preferred_shifts: [{
              shift: ["M","A","N"][idx % 3],
              days: dayNames.filter((_,k)=> (k+idx)%2===0).slice(0,4),
              priority: ["low","medium","high"][idx % 3]
            }],
            preferred_days_off: [
              { date: "2025-11-10", rank: (idx % 3)+1 },
              { date: "2025-11-20", rank: ((idx+1) % 3)+1 }
            ]
          }
        });
      }
      return out;
    }

    const ShiftLegend = () => (
      <div className="flex gap-4 text-sm my-2">
        <div className="flex items-center"><div className="w-4 h-4 shift-M mr-1"></div> Morning (M)</div>
        <div className="flex items-center"><div className="w-4 h-4 shift-A mr-1"></div> Afternoon (A)</div>
        <div className="flex items-center"><div className="w-4 h-4 shift-N mr-1"></div> Night (N)</div>
        <div className="flex items-center"><div className="w-4 h-4 shift-OFF mr-1"></div> Off</div>
        <div className="flex items-center"><div className="w-4 h-4 unmet mr-1"></div> Shortfall</div>
      </div>
    );

    function ScheduleTable({ data }) {
      if (!data?.dates?.length) return null;

      const nurseMeta = {};
      (data.nurses || []).forEach(n => { if (n?.id) nurseMeta[n.id] = n; });

      const allIds = Array.from(new Set([
        ...(data.nurses || []).map(n => n.id),
        ...(data.assignments || []).map(a => a.nurse_id),
      ])).filter(Boolean).sort();

      const assignmentMap = {};
      (data.assignments || []).forEach(a => { assignmentMap[`${a.nurse_id}-${a.date}`] = a.shift; });

      const shortfallMap = {};
      (data.shortfall || []).forEach(s => { shortfallMap[`${s.date}-${s.shift}`] = s.unmet; });

      return (
        <div className="overflow-x-auto">
          <ShiftLegend />
          <table className="min-w-full bg-white border border-gray-300">
            <thead>
              <tr className="bg-gray-100">
                <th className="py-2 px-4 border">Nurse</th>
                {data.dates.map(date => (
                  <th key={date} className="py-2 px-4 border text-sm">{fmtDay(date)}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {allIds.map(nid => {
                const nurse = nurseMeta[nid] || { id: nid };
                return (
                  <tr key={nid}>
                    <td className="py-2 px-4 border font-medium">{nurse.id}</td>
                    {data.dates.map(date => {
                      const shift = assignmentMap[`${nid}-${date}`] || 'OFF';
                      return (
                        <td key={date} className={`py-2 px-4 border text-center shift-${shift}`}>
                          {shift !== 'OFF' ? shift : ''}
                        </td>
                      );
                    })}
                  </tr>
                );
              })}
              <tr className="bg-gray-50">
                <td className="py-2 px-4 border font-bold">Coverage</td>
                {data.dates.map(date => {
                  const dayShortfalls = [];
                  (data.shifts || []).forEach(shift => {
                    const key = `${date}-${shift}`;
                    if (shortfallMap[key]) dayShortfalls.push(`${shift}: -${shortfallMap[key]}`);
                  });
                  return (
                    <td key={date} className={`py-2 px-4 border text-center text-sm ${dayShortfalls.length ? 'unmet' : ''}`}>
                      {dayShortfalls.length ? dayShortfalls.join(', ') : 'OK'}
                    </td>
                  );
                })}
              </tr>
            </tbody>
          </table>
        </div>
      );
    }

    function CoverageChart({ data }) {
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      useEffect(() => {
        if (!data.dates.length) return;

        const shiftCounts = {};
        data.dates.forEach(d => shiftCounts[d] = { M:0, A:0, N:0 });
        data.assignments.forEach(a => {
          if (shiftCounts[a.date] && shiftCounts[a.date][a.shift] !== undefined) {
            shiftCounts[a.date][a.shift]++;
          }
        });

        const reqs = {};
        data.coverage.forEach(c => {
          if (!reqs[c.date]) reqs[c.date] = {};
          reqs[c.date][c.shift] = c.req_total;
        });

        const chartData = {
          labels: data.dates.map(d => new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric'})),
          datasets: [
            { label:'Morning (M)',  data:data.dates.map(d => (shiftCounts[d]?.M ?? 0)), backgroundColor:'#bbdefb', borderColor:'#2196f3', borderWidth:1, stack:'S' },
            { label:'Afternoon (A)',data:data.dates.map(d => (shiftCounts[d]?.A ?? 0)), backgroundColor:'#ffe0b2', borderColor:'#ff9800', borderWidth:1, stack:'S' },
            { label:'Night (N)',    data:data.dates.map(d => (shiftCounts[d]?.N ?? 0)), backgroundColor:'#c8e6c9', borderColor:'#4caf50', borderWidth:1, stack:'S' },
            { label:'M Required',   data:data.dates.map(d => (reqs[d]?.M ?? 0)), type:'line', borderColor:'#1565c0', borderWidth:2, fill:false, pointRadius:3 },
            { label:'A Required',   data:data.dates.map(d => (reqs[d]?.A ?? 0)), type:'line', borderColor:'#ef6c00', borderWidth:2, fill:false, pointRadius:3 },
            { label:'N Required',   data:data.dates.map(d => (reqs[d]?.N ?? 0)), type:'line', borderColor:'#2e7d32', borderWidth:2, fill:false, pointRadius:3 },
          ]
        };

        if (chartInstance.current) chartInstance.current.destroy();
        const ctx = chartRef.current.getContext('2d');
        chartInstance.current = new Chart(ctx, {
          type: 'bar',
          data: chartData,
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, stacked: true, title: { display: true, text: 'Number of Nurses' } },
              x: { stacked: true, title: { display: true, text: 'Date' } }
            },
            plugins: { title: { display: true, text: 'Nurse Coverage vs. Requirements', font: { size: 16}}, tooltip: { mode: 'index', intersect: false } }
          }
        });

        return () => { if (chartInstance.current) chartInstance.current.destroy(); };
      }, [data]);

      return <div className="h-80 mt-6"><canvas ref={chartRef}></canvas></div>;
    }

    function ScheduleExport({ data }) {
      const exportCSV = (type) => {
        let csvData, filename;
        if (type === 'assignments') {
          csvData = Papa.unparse({ fields: ["date","shift","nurse_id"], data: data.assignments });
          filename = "assignments.csv";
        } else {
          csvData = Papa.unparse({ fields: ["date","shift","unmet"], data: data.shortfall });
          filename = "shortfalls.csv";
        }
        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = Object.assign(document.createElement("a"), { href: url, download: filename, style: 'visibility:hidden' });
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
      };
      return (
        <div className="my-4 flex flex-wrap gap-3">
          <button onClick={() => exportCSV('assignments')} className="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded shadow transition" disabled={!data.assignments.length}>Export Assignments</button>
          <button onClick={() => exportCSV('shortfalls')} className="bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded shadow transition" disabled={!data.shortfall.length}>Export Shortfalls</button>
        </div>
      );
    }

    function SolverControls({ onOptimize, filePath, disabled }) {
      const [timeLimit, setTimeLimit] = useState(60);
      const [threads, setThreads]   = useState(8);
      const [isOptimizing, setIsOptimizing] = useState(false);
      const [progress, setProgress] = useState({ status:"idle", message:"", percent:0 });
      const statusCheckInterval = useRef(null);

      const handleOptimize = () => {
        setIsOptimizing(true);
        fetch(`${UI_BASE}/api/solve`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ file_path:filePath, time_limit:Number(timeLimit), threads:Number(threads) })
        })
          .then(r => r.json())
          .then(d => {
            if (d.error) throw new Error(d.error);
            statusCheckInterval.current = setInterval(checkStatus, 1000);
          })
          .catch(err => { console.error(err); setIsOptimizing(false); });
      };

      const checkStatus = () => {
        fetch(`${UI_BASE}/api/status`)
          .then(r => r.json())
          .then(d => {
            setProgress(d);
            if (d.status === 'completed' || d.status === 'error') {
              if (statusCheckInterval.current) clearInterval(statusCheckInterval.current);
              setIsOptimizing(false);
              if (d.status === 'completed') onOptimize();
            }
          })
          .catch(err => { console.error(err); if (statusCheckInterval.current) clearInterval(statusCheckInterval.current); setIsOptimizing(false); });
      };

      useEffect(() => () => { if (statusCheckInterval.current) clearInterval(statusCheckInterval.current); }, []);

      return (
        <div className="bg-white shadow rounded p-4">
          <h3 className="text-lg font-bold mb-3">Solver Configuration</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label className="block text-sm font-medium mb-1">Time Limit (seconds)</label>
              <input type="number" min="1" max="600" value={timeLimit} onChange={e=>setTimeLimit(e.target.value)} className="w-full border rounded py-2 px-3 text-gray-700" disabled={isOptimizing}/>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Threads</label>
              <input type="number" min="1" max="32" value={threads} onChange={e=>setThreads(e.target.value)} className="w-full border rounded py-2 px-3 text-gray-700" disabled={isOptimizing}/>
            </div>
          </div>

          {isOptimizing && (
            <div className="mb-4">
              <div className="flex justify-between mb-1">
                <span className="text-sm font-medium">{progress.message}</span>
                <span className="text-sm font-medium">{progress.percent}%</span>
              </div>
              <div className="w-full bg-gray-200 rounded-full h-2.5">
                <div className="bg-blue-600 h-2.5 rounded-full" style={{width: progress.percent + "%"}}></div>
              </div>
              {progress?.diagnostics && (
                <div className="mt-2 text-xs text-gray-700">
                  Status: <b>{progress.diagnostics.status_name}</b>
                </div>
              )}
            </div>
          )}

          <button onClick={handleOptimize} disabled={isOptimizing || disabled} className="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-6 rounded shadow transition disabled:bg-indigo-300">
            {isOptimizing ? 'Optimizing...' : 'Run Optimization'}
          </button>
        </div>
      );
    }

    // --------- Step 1 (Chatbot & Manager) — FIXED ----------
    function ChatbotAndManager({ onConfigReady, nursesState, setNursesState }) {
      const [status, setStatus] = useState({ chatbotOK: null, message: '' });
      const [simText, setSimText]   = useState('ขอลางานวันที่ 15 ระดับความสำคัญ 1');
      const [simUser, setSimUser]   = useState(''); // no DEV_USER default
      const [simLoading, setSimLoading] = useState(false);
      const [version, setVersion] = useState(0);    // bump to force preview refresh

      // ISO helpers to avoid TZ drift
      const isoToday = () => new Date(Date.now() - (new Date().getTimezoneOffset()*60000)).toISOString().slice(0,10);
      const addDaysISO = (iso, k) => {
        const d = new Date(iso + 'T00:00:00'); d.setDate(d.getDate()+k);
        return new Date(d.getTime() - (d.getTimezoneOffset()*60000)).toISOString().slice(0,10);
      };

      const [horizonStart, setHorizonStart] = useState(isoToday());
      const [horizonEnd, setHorizonEnd]     = useState(addDaysISO(isoToday(), 6));
      const [shifts, setShifts] = useState(['M','A','N']);
      const [reqBase, setReqBase] = useState({ M: 2, A: 2, N: 1 });
      const [weights, setWeights] = useState(defaultWeights);
      const [compiledCfg, setCompiledCfg] = useState(null);

      const noCache = (url) => `${url}${url.includes('?')?'&':'?'}_=${Date.now()}`;

      const importFromChatbot = async () => {
        try {
          setStatus({ chatbotOK: null, message: 'Fetching nurses from chatbot…' });
          const resp = await fetch(noCache(`${CHATBOT_PROXY}/export_all`), { cache: 'no-store' });
          const j = await resp.json().catch(()=> ({}));

          // accept { nurses: [...] } or { data: { nurses: [...] } }
          let nurses = Array.isArray(j.nurses) ? j.nurses
                    : Array.isArray(j?.data?.nurses) ? j.data.nurses
                    : [];

          // Normalize safely; DO NOT force any “Dev” name/id
          nurses = nurses.map(n => ({
            ...n,
            id: n.id || n.nurse_id || '',
            name: n.name ?? (n.id ? `Nurse ${n.id}` : 'Nurse'),
            level: Number(n.level ?? 1),
            employment_type: n.employment_type || 'full_time',
            unit: n.unit || 'ER',
            preferences: {
              preferred_shifts: Array.isArray(n.preferences?.preferred_shifts) ? n.preferences.preferred_shifts : [],
              preferred_days_off: Array.isArray(n.preferences?.preferred_days_off) ? n.preferences.preferred_days_off : []
            }
          })).filter(n => n.id);

          const padded = ensureMinNurses(nurses, TARGET_MIN_NURSES);

          // Force a new reference + bump version so preview re-renders
          setNursesState(JSON.parse(JSON.stringify(padded)));
          setVersion(v => v + 1);

          setStatus({
            chatbotOK: true,
            message: `Imported ${nurses.length}${padded.length>nurses.length ? ` + padded ${padded.length-nurses.length}`:''}. Total: ${padded.length}.`
          });
        } catch (e) {
          const fallback = ensureMinNurses([], TARGET_MIN_NURSES);
          setNursesState(fallback);
          setVersion(v => v + 1);
          setStatus({ chatbotOK: false, message: `Chatbot unreachable — loaded ${TARGET_MIN_NURSES} toy nurses locally.` });
        }
      };

      const resetDemoDB = async () => {
        setStatus({ chatbotOK: null, message: 'Resetting demo DB…' });
        try {
          const res = await fetch(noCache(`${CHATBOT_PROXY}/dev/resetdb`), { method: 'POST' });
          const j = await res.json().catch(()=>({}));
          if (!res.ok || j.ok === false) throw new Error(j.error || `HTTP ${res.status}`);
          await importFromChatbot();
        } catch (e) {
          setStatus({ chatbotOK: false, message: `Reset failed: ${e.message}` });
        }
      };

      const simulateIntent = async () => {
        if (!simUser.trim()) { setStatus({ chatbotOK:false, message:'Please enter a User ID (e.g., N013 or your LINE user id).' }); return; }
        if (!simText.trim()) { setStatus({ chatbotOK:false, message:'Please enter a message to send to the chatbot.' }); return; }

        setSimLoading(true);
        try {
          const body = { text: simText.trim(), user_id: simUser.trim() };  // use your entered ID verbatim
          setStatus({ chatbotOK: null, message: `Posting: ${JSON.stringify(body)}` });

          const resp = await fetch(noCache(`${CHATBOT_PROXY}/dev/callback_test`), {
            method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(body)
          });
          const data = await resp.json().catch(()=> ({}));
          if (!resp.ok || data.ok === false) throw new Error(data.error || data.message || `HTTP ${resp.status}`);

          setStatus({ chatbotOK: true, message: `Stored (intent: ${data.intent || 'ok'}) for user_id=${body.user_id}. Re-importing…` });
          await new Promise(r => setTimeout(r, 250));
          await importFromChatbot();  // pulls latest so preview changes
        } catch (e) {
          setStatus({ chatbotOK:false, message:`Simulation error: ${e.message}` });
        } finally {
          setSimLoading(false);
        }
      };

      const buildCoverage = () => {
        if (horizonStart > horizonEnd) return [];
        const days = rangeDates(horizonStart, horizonEnd);
        const cov = [];
        days.forEach(d => {
          shifts.forEach(s => cov.push({ date:d, shift:s, req_total: Math.max(0, Number(reqBase[s] ?? 0)) }));
        });
        return cov;
      };

      const compileConfig = () => {
        if (horizonStart > horizonEnd) { setStatus({chatbotOK:false, message:'Invalid horizon: Start must be ≤ End.'}); return; }
        if (shifts.length === 0) { setStatus({chatbotOK:false, message:'Select at least one shift (M/A/N).'}); return; }

        const shift_types = shifts.map(code => ({ code }));
        const cfg = {
          nurses: ensureMinNurses(nursesState, TARGET_MIN_NURSES),
          shift_types,
          coverage_requirements: buildCoverage(),
          date_horizon: { start: horizonStart, end: horizonEnd },
          policy_parameters: {
            weights: {
              pref_shift_weight: Number(weights.pref_shift_weight),
              pref_dayoff_weight: Number(weights.pref_dayoff_weight),
              shortfall_penalty: Number(weights.shortfall_penalty),
              overage_penalty: Number(weights.overage_penalty),
            },
            no_consecutive_nights: !!weights.no_consecutive_nights,
            WSMin: Number(weights.WSMin),
            WSMax: Number(weights.WSMax),
            head_nurse_id: (weights.head_nurse_id || '').trim() || null,
            hard_dayoffs: []
          }
        };
        setCompiledCfg(cfg);
        onConfigReady(cfg);
        setStatus({ chatbotOK:true, message:`Config built: ${cfg.coverage_requirements.length} coverage rows, ${cfg.nurses.length} nurses.` });
      };

      useEffect(() => { importFromChatbot(); }, []);

      return (
        <div className="bg-white shadow rounded p-4 mb-6">
          <h2 className="text-xl font-bold mb-4">Step 1 — Chatbot & Local Test</h2>

          <div className="flex flex-wrap gap-3 mb-3">
            <button onClick={importFromChatbot} className="bg-teal-700 hover:bg-teal-800 text-white px-4 py-2 rounded">Import nurses from chatbot</button>
            <button onClick={simulateIntent} disabled={simLoading} className="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded disabled:bg-slate-400">
              {simLoading ? 'Simulating…' : 'Simulate intent → store'}
            </button>
            <button onClick={importFromChatbot} className="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">Refresh from chatbot</button>
            <button onClick={resetDemoDB} className="bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded">Reset demo DB</button>
          </div>

          <div className="mt-3 grid md:grid-cols-3 gap-3">
            <div>
              <label className="block text-sm font-medium mb-1">User ID (exact)</label>
              <input className="w-full border rounded py-2 px-3" value={simUser} onChange={e=>setSimUser(e.target.value)} placeholder="e.g., N013 or your LINE user id"/>
            </div>
            <div className="md:col-span-2">
              <label className="block text-sm font-medium mb-1">Sample chatbot message</label>
              <textarea className="w-full border rounded py-2 px-3" rows="2" value={simText} onChange={e=>setSimText(e.target.value)} placeholder="e.g., ขอลางานวันที่ 15 ระดับความสำคัญ 1"></textarea>
            </div>
            <div>
              <button onClick={simulateIntent} disabled={simLoading} className="mt-6 bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded disabled:bg-slate-400">
                {simLoading ? 'Sending…' : 'Send to chatbot'}
              </button>
            </div>
          </div>

          {status.message && (
            <div className={`mt-3 p-3 rounded ${status.chatbotOK===true ? 'bg-green-50 text-green-800' : status.chatbotOK===false ? 'bg-red-50 text-red-800' : 'bg-yellow-50 text-yellow-800'}`}>
              {status.message}
            </div>
          )}

          {/* version attribute + key variant ensure preview refresh */}
          <div className="bg-gray-50 rounded p-3 mt-4" data-version={version}>
            <div className="text-sm font-semibold mb-2">Nurses (preview)</div>
            <div className="h-40 overflow-auto text-sm">
              {nursesState.length === 0 ? (
                <div className="text-gray-500">No nurses yet — import from chatbot.</div>
              ) : nursesState.map(n => (
                <div key={`${n.id}-${version}`} className="border-b py-1">
                  <div className="font-medium">{n.id} — {n.name || 'Unnamed'}</div>
                  <div className="text-gray-600">Lvl {n.level || 1} • {n.employment_type || 'full_time'} • {n.unit || 'ER'}</div>
                  {Array.isArray(n.preferences?.preferred_shifts) && n.preferences.preferred_shifts.length > 0 && (
                    <div className="text-gray-700">
                      pref_shifts: {n.preferences.preferred_shifts.map(p=>`${p.shift}[${(p.days||[]).join('/')}](${p.priority||''})`).join('; ')}
                    </div>
                  )}
                  {Array.isArray(n.preferences?.preferred_days_off) && n.preferences.preferred_days_off.length > 0 && (
                    <div className="text-gray-700">
                      days_off: {n.preferences.preferred_days_off.map(p=>`${p.date || 'NA'}(rank ${p.rank ?? ''})`).join('; ')}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>

          <h2 className="text-xl font-bold my-4">Step 2 — Manager (compile config)</h2>
          <div className="grid md:grid-cols-3 gap-4">
            <div className="bg-gray-50 rounded p-3">
              <div className="font-semibold mb-2">Date horizon</div>
              <label className="block text-sm mb-1">Start</label>
              <input type="date" value={horizonStart}
                    onChange={e=>setHorizonStart(e.target.value)}
                    className="w-full border rounded py-2 px-3 mb-2"/>
              <label className="block text-sm mb-1">End</label>
              <input type="date" value={horizonEnd}
                    onChange={e=>setHorizonEnd(e.target.value)}
                    className="w-full border rounded py-2 px-3"/>
              {horizonStart > horizonEnd && (
                <div className="text-xs text-red-700 mt-1">Start must be before or equal to End.</div>
              )}
            </div>

            <div className="bg-gray-50 rounded p-3">
              <div className="font-semibold mb-2">Shifts & coverage (quick)</div>
              <div className="flex gap-2 mb-2">
                {['M','A','N'].map(s => (
                  <label key={s} className="flex items-center gap-1 text-sm">
                    <input type="checkbox" checked={shifts.includes(s)} onChange={()=>{
                      setShifts(prev => prev.includes(s) ? prev.filter(x=>x!==s) : [...prev, s]);
                    }}/> {s}
                  </label>
                ))}
              </div>
              {['M','A','N'].map(s => (
                <div key={s} className="flex items-center justify-between mb-2">
                  <span className="text-sm">{s} required per day</span>
                  <input type="number" min="0" className="border rounded w-20 py-1 px-2"
                        value={Number.isFinite(reqBase[s]) ? reqBase[s] : 0}
                        onChange={e=>setReqBase(v => ({...v, [s]: Math.max(0, Number(e.target.value))}))} />
                </div>
              ))}
            </div>

            <div className="bg-gray-50 rounded p-3">
              <div className="font-semibold mb-2">Policy & Hard Rules</div>

              <label className="block text-sm mb-1">Preferred shift weight</label>
              <input type="number" step="0.1" value={weights.pref_shift_weight}
                    onChange={e=>setWeights(w=>({...w, pref_shift_weight: Number(e.target.value)}))}
                    className="w-full border rounded py-2 px-3 mb-2"/>

              <label className="block text-sm mb-1">Preferred day-off weight</label>
              <input type="number" step="0.1" value={weights.pref_dayoff_weight}
                    onChange={e=>setWeights(w=>({...w, pref_dayoff_weight: Number(e.target.value)}))}
                    className="w-full border rounded py-2 px-3 mb-2"/>

              <label className="block text-sm mb-1">Shortfall penalty</label>
              <input type="number" step="1" value={weights.shortfall_penalty}
                    onChange={e=>setWeights(w=>({...w, shortfall_penalty: Number(e.target.value)}))}
                    className="w-full border rounded py-2 px-3 mb-2"/>

              <label className="block text-sm mb-1">Overage penalty</label>
              <input type="number" step="1" value={weights.overage_penalty}
                    onChange={e=>setWeights(w=>({...w, overage_penalty: Number(e.target.value)}))}
                    className="w-full border rounded py-2 px-3 mb-2"/>

              <label className="flex items-center gap-2 text-sm mb-2">
                <input type="checkbox" checked={!!weights.no_consecutive_nights}
                      onChange={e=>setWeights(w=>({...w, no_consecutive_nights: e.target.checked}))}/>
                No consecutive nights
              </label>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">WSMin (per nurse)</label>
                  <input type="number" min="0" value={weights.WSMin}
                        onChange={e=>setWeights(w=>({...w, WSMin: Number(e.target.value)}))}
                        className="w-full border rounded py-2 px-3"/>
                </div>
                <div>
                  <label className="block text-sm mb-1">WSMax (per nurse)</label>
                  <input type="number" min="0" value={weights.WSMax}
                        onChange={e=>setWeights(w=>({...w, WSMax: Number(e.target.value)}))}
                        className="w-full border rounded py-2 px-3"/>
                </div>
              </div>

              <label className="block text-sm mb-1 mt-2">Head nurse ID (optional)</label>
              <input value={weights.head_nurse_id}
                    onChange={e=>setWeights(w=>({...w, head_nurse_id: e.target.value}))}
                    className="w-full border rounded py-2 px-3" placeholder="e.g., N001"/>
            </div>
          </div>

          <div className="mt-4 flex gap-3">
            <button onClick={compileConfig} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">Build config</button>
          </div>

          {compiledCfg && (
            <div className="mt-4">
              <div className="text-sm font-semibold mb-2">Compiled config (preview)</div>
              <pre className="bg-gray-900 text-green-200 p-3 rounded overflow-auto" style={{maxHeight:'280px'}}>
                <code className="small">{JSON.stringify(compiledCfg, null, 2)}</code>
              </pre>
            </div>
          )}
        </div>
      );
    }

    function FileUploader({ onUploaded }) {
      const [isUploading, setIsUploading] = useState(false);
      const [error, setError] = useState('');

      const handleUploadFromDisk = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        setIsUploading(true); setError('');
        const formData = new FormData(); formData.append('file', file);
        fetch(`${UI_BASE}/api/upload`, { method:'POST', body: formData })
          .then(res => res.json())
          .then(data => { if (data.error) throw new Error(data.error); onUploaded(data); })
          .catch(err => setError(err.message || 'Upload error'))
          .finally(()=> setIsUploading(false));
      };

      return (
        <div className="bg-white shadow rounded p-4 mb-6">
          <h2 className="text-xl font-bold mb-3">Step 3 — Optimize & View</h2>
          <div className="flex flex-wrap items-center gap-3">
            <label className="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded shadow transition cursor-pointer">
              {isUploading ? 'Processing...' : 'Upload JSON (manual)'}
              <input type="file" accept=".json" className="hidden" onChange={handleUploadFromDisk} disabled={isUploading}/>
            </label>
            {error && <span className="text-red-700">{error}</span>}
          </div>
        </div>
      );
    }

    function App() {
      const [nurses, setNurses] = useState([]);
      const [compiledConfig, setCompiledConfig] = useState(null);
      const [fileMeta, setFileMeta] = useState(null);
      const [solution, setSolution] = useState(initialData);
      const [objective, setObjective] = useState(null);
      const [dataLoaded, setDataLoaded] = useState(false);

      useEffect(() => { setCompiledConfig(null); setFileMeta(null); }, [nurses]);

      const uploadCompiled = async () => {
        if (!compiledConfig) return;
        const blob = new Blob([JSON.stringify(compiledConfig)], { type: 'application/json' });
        const file = new File([blob], 'compiled_config.json', { type: 'application/json' });
        const formData = new FormData(); formData.append('file', file);
        const res = await fetch(`${UI_BASE}/api/upload`, { method:'POST', body: formData });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        setFileMeta(data);
      };

      const fetchSolution = () => {
        fetch(`${UI_BASE}/api/solution`)
          .then(r => { if (!r.ok && r.status !== 404) throw new Error('Solution fetch failed'); return r.json(); })
          .then(d => {
            if (d?.error) return;
            setSolution(d);
            if (typeof d.objective === 'number') setObjective(d.objective);
            setDataLoaded(true);
          })
          .catch(err => console.error(err));
      };

      return (
        <div className="container mx-auto px-4 py-8 max-w-7xl">
          <header className="mb-8">
            <h1 className="text-3xl font-bold text-gray-800">Nurse Scheduling System</h1>
            <p className="text-gray-600 mt-2">Complete demo: LINE chatbot → Manager → Optimizer → Visualization</p>
          </header>

          <ChatbotAndManager
            onConfigReady={(cfg)=>{ setCompiledConfig(cfg); }}
            nursesState={nurses}
            setNursesState={setNurses}
          />

          <div className="bg-white shadow rounded p-4 mb-6">
            <div className="flex flex-wrap gap-3 items-center">
              <button
                onClick={async ()=>{ try { await uploadCompiled(); } catch(e){ alert(e.message); } }}
                disabled={!compiledConfig}
                className="bg-purple-700 hover:bg-purple-800 text-white py-2 px-4 rounded disabled:bg-purple-300"
              >
                Upload compiled config to /api/upload
              </button>
              {fileMeta && (
                <span className="text-sm text-gray-600">
                  Uploaded: <code className="small">{fileMeta.file_path}</code> | Nurses: {fileMeta.nurses} | Coverage rows: {fileMeta.coverage_requirements}
                </span>
              )}
            </div>

            {fileMeta && (
              <div className="mt-4">
                <SolverControls onOptimize={fetchSolution} filePath={fileMeta.file_path} disabled={!fileMeta.file_path}/>
              </div>
            )}
          </div>

          {dataLoaded && (
            <>
              {typeof objective === 'number' && (
                <div className="bg-white shadow rounded p-4 mb-6">
                  <h2 className="text-lg font-bold mb-2">Solution Summary</h2>
                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div className="bg-blue-50 p-3 rounded">
                      <div className="text-sm text-blue-800">Objective Value</div>
                      <div className="text-2xl font-bold">{objective.toFixed(2)}</div>
                    </div>
                    <div className="bg-green-50 p-3 rounded">
                      <div className="text-sm text-green-800">Total Assignments</div>
                      <div className="text-2xl font-bold">{solution.assignments.length}</div>
                    </div>
                    <div className="bg-red-50 p-3 rounded">
                      <div className="text-sm text-red-800">Days with Shortfall</div>
                      <div className="text-2xl font-bold">{new Set((solution.shortfall || []).filter(s => (s.unmet || 0) > 0).map(s => s.date)).size}</div>
                    </div>
                  </div>

                  {solution?.diagnostics && (
                    <div className="bg-gray-50 p-3 rounded mt-3 text-sm">
                      <div><span className="font-semibold">Status:</span> {solution.diagnostics.status_name}</div>
                      {"coverage_met_pct" in solution.diagnostics && (
                        <div><span className="font-semibold">Coverage met:</span> {solution.diagnostics.coverage_met_pct.toFixed(1)}%</div>
                      )}
                      {"coverage_unmet" in solution.diagnostics && (
                        <div><span className="font-semibold">Total unmet:</span> {solution.diagnostics.coverage_unmet}</div>
                      )}
                    </div>
                  )}
                </div>
              )}

              <div className="bg-white shadow rounded p-4 mb-6">
                <h2 className="text-lg font-bold mb-4">Schedule Visualization</h2>
                <ScheduleTable data={solution} />
              </div>

              <div className="bg-white shadow rounded p-4 mb-6">
                <h2 className="text-lg font-bold mb-4">Coverage Analysis</h2>
                <CoverageChart data={solution} />
              </div>

              <ScheduleExport data={solution} />
            </>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>